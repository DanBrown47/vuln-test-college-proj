<section>
    <div class="container">
        <div class="card pl-3">
            <div class="class-head">
                <div class="row">
                    {{#each subject}}
                    <h1>{{this.name}}</h1><i class="far fa-info-circle"></i>
                </div>
            </div>
            <div class="subjectId row">
                <div id="subject-Id">{{this.subject_id}}</div>&nbsp;<a class="btn btn-" onclick="copySubjectId()"><i
                        class="far fa-copy"></i></a>
            </div>
            <div class="row pl-3">
                {{#each this.class}}
                <h5 class="w-50" style="padding-left: 15px; padding-top: 0;;">{{this.name}}</h5>
                {{/each}}
                {{/each}}
            </div>
        </div>
        <a href="" data-toggle="modal" data-target="#postClass" style="text-decoration: none; color : #000">
            <div class="card1 mt-3"><small>Post your class here...</small></div>
        </a>
        {{#if subject}}
        <div class="card2">

        </div>
        {{else}}
        <center>
            <div class="blank">You haven't posted anything</div>
        </center>
        {{/if}}
    </div>
</section>

<div class="modal fade" id="postClass" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5>Create your post</h5>
                <div class="close-btn" data-dismiss="modal"><i class="fal fa-times"></i></div>
            </div>
            <div class="modal-body">
                <form class="form" id="uploadForm" action="/tutor/upload-class" method="post">
                {{#each subject}}
                <input type="text" name="subject" value="{{this._id}}" hidden>
                {{/each}}
                    <div class="form-group">
                        <input type="text" class="form-control" id="topic-name" name="name" placeholder="Topic"
                            required>
                    </div>
                    <div class="form-group">
                        <textarea rows="6" name="content" placeholder="write something here..."
                            class="form-control"></textarea>
                    </div>
                    <br>
                    <hr class="p-0" style="background: #5f9ea0">
                    <br>
                    <div class="icons">

                        <div class="file-upload">
                            <input class="file-upload__input" type="file"
                                accept="image/*,application/pdf,.xlsx,.pptx,.txt,.pps,.doc,.docx"
                                name="file" id="myFile" multiple>
                            <button class="file-upload__button" type="button">Choose File(s)</button>
                            <span class="file-upload__label"></span>
                        </div>
                        {{!-- <div class="progress-bar" id="progressBar">
                            <div class="progress-bar-fill">
                                <span class="progress-bar-text"></span>
                            </div>
                        </div> --}}
                        <div id="progress-part"></div>

                        <div class="row" style="padding: 25px 0px 0px 5px;">
                            <a class="btn-btn addLink" onclick="addLink()"><i class="far fa-plus"></i></a>&nbsp;&nbsp;
                            <div class="link">Add Link</div>
                        </div>
                        <div id="new_chq"></div>
                        <input type="hidden" value="1" id="total_chq">
                    </div>
            </div>
            <div class="modal-footer">
                <button type="submit" class="btn btn-dark">Create</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>

    /* Function for copying subject id*/
    function copySubjectId() {

        if (document.selection) {
            var range = document.body.createTextRange();
            range.moveToElementText(document.getElementById("subject-Id"));
            range.select().createTextRange();
            document.execCommand("copy");
        } 
        else if (window.getSelection) {
            var range = document.createRange();
            range.selectNode(document.getElementById("subject-Id"));
            window.getSelection().addRange(range);
            document.execCommand("copy");
        }
    }

    /*Function ends*/

    /* Function to add link on button click */
    function addLink() {
        var new_chq_no = parseInt($('#total_chq').val()) + 1;
        var new_input = "<div class='row' id='input-box' style='padding-top : 10px;'><input type='url' class='form-control' name='link' placeholder='https://example.com' id='new_" + new_chq_no + "'><a class='btn-btn removeLink' onclick='removeLink()'><i class='fas fa-minus' id='remove_" + new_chq_no + "'></i></a></div>";

        $('#new_chq').append(new_input);

        $('#total_chq').val(new_chq_no);
    }

    /*Function ends*/

    /* Function to remove link on button click */
    function removeLink() {
        var last_chq_no = $('#total_chq').val();

        if (last_chq_no > 1) {
            $('#new_' + last_chq_no).remove();
            $('#remove_' + last_chq_no).remove();
            const myobj = document.getElementById("input-box");
            myobj.remove();
            $('#total_chq').val(last_chq_no - 1);
        }
    }

    /* Script for custom upload button that takes multiple files */
    Array.prototype.forEach.call(
        document.querySelectorAll(".file-upload__button"),
        function (button) {
            const hiddenInput = button.parentElement.querySelector(
                ".file-upload__input"
            );
            const label = button.parentElement.querySelector(".file-upload__label");
            const defaultLabelText = "No file(s) selected";

            // Set default text for label
            label.textContent = defaultLabelText;
            label.title = defaultLabelText;

            button.addEventListener("click", function () {
                hiddenInput.click();
            });

            hiddenInput.addEventListener("change", function () {
                const filenameList = Array.prototype.map.call(hiddenInput.files, function (file) {
                    return file.name;
                });

                label.textContent = filenameList.join(", ") || defaultLabelText;
                label.title = label.textContent;
            });
        }
    );

    /*Script to check file size and to give progress bar on front end*/
    const uploadForm = document.getElementById("uploadForm");
    let status = true;
    uploadForm.addEventListener("submit", uploadFile);
    async function uploadFile(e) {
        const file = document.getElementById("myFile").files;
        for (let i = 0; i < file.length; i++) {
            var fileSizeInMB = ((file[i].size / 1024) / 1024).toFixed(4);
            if (fileSizeInMB > 15) {
                status = false;
                break;
            }
        }
        if (status === true) {
            if (file.length != 0) {
                e.preventDefault();
                let new_element = "<div class='progress' id='progressBar'><div class='progress-bar progress-bar-striped progress-bar-animated bg-dark progress-bar-fill' role='progressbar' aria-valuenow='75' aria-valuemin='0' aria-valuemax='100'><span class='progress-bar-text'></span></div></div>"
                document.getElementById("progress-part").innerHTML = new_element;
                const progressBarFill = document.querySelector("#progressBar > .progress-bar-fill");
                const progressBarText = progressBarFill.querySelector(".progress-bar-text");

                const xhr = new XMLHttpRequest();
               xhr.open("POST", "/tutor/upload-class");

                /*Function that updating values in progress bar*/
                xhr.upload.addEventListener("progress", e => {
                    const percent = e.lengthComputable ? (e.loaded / e.total) * 100 : 0;
                    progressBarFill.style.width = percent.toFixed(2) + "%";
                    progressBarText.textContent = percent.toFixed(2) + "%";
                    console.log(progressBarFill.style.width);
                    if(progressBarFill.textContent === "100.00%"){
                        window.location.reload();
                }
                });
                xhr.send(new FormData(uploadForm));
            }
        }
        else {
            let error_message = "<div class='error-text'><small style='color : red'>*Files with size above 15MB is not accepted.</small></div>"
            document.getElementById("progress-part").innerHTML = error_message;
            e.preventDefault();
            status = true;
        }

    }
</script>

<style>
    .card {
        background: #2a265f;
        color: #fff;
        padding: 15px 0px 0px 15px;
        font-size: 14px;
        margin-bottom: 10px;
        border-radius: 10px;
        height: 250px;
        position: relative;
    }

    @media screen and (max-width : 400px) {
        .card {
            background: #2a265f;
            color: #fff;
            padding: 15px 0px 0px 15px;
            font-size: 14px;
            margin-bottom: 10px;
            border-radius: 10px;
            height: 150px;
            position: relative;
        }
        .card .class-head h1{
            font-size: 22px;
        }
    }

    .class-head {
        padding-left: 15px;
    }

    @media screen and (min-width : 401px) {
        .class-head {
            padding-left: 30px;
            padding-top: 35px;
        }
    }

    .subjectId {
        position: absolute;
        right: 0;
        bottom: 0;
        padding: 10px;
    }

    .subjectId #subject-Id{
        padding-top: 8px;
    }

    .card1 {
        background-color: #fff;
        padding: 15px 0px 0px 15px;
        border-radius: 10px;
        box-shadow: 5px 5px 10px #aaaaaa;
        height: 54px;
    }

    .card2 {
        position: relative;
    }

    .blank {
        letter-spacing: .00625em;
        font-size: 1rem;
        font-weight: 500;
        line-height: 1.5rem;
        color: #3c4043;
        margin-top: 10%;
    }

    @media screen and (max-width : 400px) {
        .blank {
            letter-spacing: .00625em;
            font-size: 1rem;
            font-weight: 500;
            line-height: 1.5rem;
            color: #3c4043;
            margin-top: 20%;
        }
    }

    .file-upload {
        display: inline-flex;
        align-items: center;

        border: 12px #000;
    }

    .file-upload__input {
        display: none;
    }

    .file-upload__button {
        -webkit-appearance: none;
        background: #1a1818;
        border: 2px solid #000;
        border-radius: 4px;
        outline: none;
        padding: 0.5em 0.8em;
        margin-right: 15px;
        color: #ffffff;
        cursor: pointer;
    }

    .file-upload__button:active {
        background: #000;
    }

    .file-upload__label {
        max-width: 250px;
        font-size: 0.95em;
        text-overflow: ellipsis;
        overflow: hidden;
        white-space: nowrap;
    }

    .progress {
        height: 22px;
        margin-top: 14px;
    }

    .progress-bar-fill {
        height: 100%;
        width: 0%;
        display: flex;
        align-items: center;
        font-weight: bold;
        transition: width 0.25s;
    }

    .progress-bar-text {
        margin-left: 10px;
        font-weight: bold;

    }

    .addLink i {
        border: 2px solid #000;
        color: #000;
        display: block;
        font-size: 18px;
        width: 34px;
        height: 34px;
        line-height: 32px;
        text-align: center;
        border-radius: 50%;
        cursor: pointer;
    }

    .removeLink i {
        border: 2px solid #fff;
        color: #fff;
        display: block;
        font-size: 19px;
        width: 39px;
        height: 39px;
        line-height: 37px;
        text-align: center;
        border-radius: 21%;
        background: black;
        cursor: pointer;
    }

    .link {
        padding-top: 4px;
    }

    #input-box input {
        width: 26em;
    }

    @media screen and (max-width : 514px) {
        #input-box input {
            width: 19em;
        }
    }
</style>